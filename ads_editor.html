<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fowler Homes - Google Ads Editor</title>
<style>
  :root {
    --bg: #f5f6fa;
    --surface: #ffffff;
    --surface2: #f0f1f5;
    --accent: #e94560;
    --accent2: #7c3aed;
    --text: #1e293b;
    --text-dim: #64748b;
    --green: #059669;
    --blue: #2563eb;
    --yellow: #d97706;
    --border: #e2e8f0;
    --google-blue: #1a0dab;
    --google-green: #006621;
    --google-grey: #545454;
    --google-url: #202124;
    --serp-bg: #fff;
    --serp-text: #202124;
    --serp-desc: #4d5156;
    --serp-url: #202124;
    --ad-label: #e8710a;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* Layout */
  .app { display: flex; height: 100vh; }
  .sidebar {
    width: 300px;
    min-width: 300px;
    background: var(--surface);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }
  .main {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
  }

  /* Sidebar */
  .sidebar-header {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--surface);
    z-index: 10;
  }
  .sidebar-header h1 {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
    margin-bottom: 4px;
  }
  .sidebar-header p {
    font-size: 11px;
    color: var(--text-dim);
  }
  .filter-bar {
    padding: 12px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    gap: 6px;
  }
  .filter-btn {
    padding: 4px 10px;
    border-radius: 12px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    font-size: 11px;
    cursor: pointer;
    transition: all .15s;
  }
  .filter-btn.active, .filter-btn:hover {
    background: var(--text);
    color: #fff;
    border-color: var(--text);
  }
  .campaign-list { flex: 1; overflow-y: auto; }
  .campaign-item {
    padding: 12px 20px;
    cursor: pointer;
    border-bottom: 1px solid var(--border);
    transition: background .15s;
  }
  .campaign-item:hover { background: #f8f9fc; }
  .campaign-item.active { background: #f0f1f5; border-left: 3px solid var(--accent); }
  .campaign-item .name {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 2px;
  }
  .campaign-item .meta {
    font-size: 10px;
    color: var(--text-dim);
    display: flex;
    gap: 8px;
  }
  .badge {
    display: inline-block;
    padding: 1px 6px;
    border-radius: 3px;
    font-size: 9px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .badge-brand { background: #ede9fe; color: #6d28d9; }
  .badge-services { background: #dbeafe; color: #1d4ed8; }
  .badge-enabled { background: #d1fae5; color: #047857; }

  /* Main content */
  .campaign-header {
    margin-bottom: 28px;
  }
  .campaign-header h2 {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 8px;
  }
  .campaign-meta {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 12px;
  }
  .meta-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 16px;
    min-width: 120px;
  }
  .meta-card label {
    display: block;
    font-size: 10px;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 2px;
  }
  .meta-card .value {
    font-size: 14px;
    font-weight: 600;
  }
  .comment-bar {
    background: #fffbeb;
    border: 1px solid #fde68a;
    border-radius: 6px;
    padding: 8px 14px;
    font-size: 12px;
    color: #92400e;
    margin-top: 8px;
  }

  /* USP Summary */
  .usp-box {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    border-radius: 8px;
    padding: 14px 18px;
    margin-top: 12px;
  }
  .usp-box-title {
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #15803d;
    margin-bottom: 8px;
  }
  .usp-list {
    list-style: none;
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }
  .usp-tag {
    background: #dcfce7;
    border: 1px solid #bbf7d0;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 12px;
    color: #166534;
  }
  .usp-tag.usp-note {
    background: #fefce8;
    border-color: #fde68a;
    color: #92400e;
  }

  /* Sections */
  .section {
    margin-bottom: 32px;
  }
  .section-title {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--text-dim);
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .section-title .count {
    background: #dbeafe;
    color: #1e40af;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
  }

  /* SERP Preview */
  .serp-container {
    background: var(--serp-bg);
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
    box-shadow: 0 1px 4px rgba(0,0,0,.08), 0 0 0 1px rgba(0,0,0,.04);
    position: relative;
  }
  .serp-label {
    position: absolute;
    top: 8px;
    right: 12px;
    font-size: 10px;
    color: var(--text-dim);
    background: var(--surface2);
    padding: 2px 8px;
    border-radius: 4px;
  }
  .serp-ad-label {
    font-size: 12px;
    font-weight: 700;
    color: var(--serp-url);
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .serp-ad-label .sponsored {
    font-size: 11px;
    font-weight: 700;
    color: var(--serp-url);
  }
  .serp-url-line {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
  }
  .serp-favicon {
    width: 18px;
    height: 18px;
    background: #e0e0e0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    color: #666;
  }
  .serp-url-wrap {
    background: #f0f0f0;
    border-radius: 12px;
    padding: 4px 10px;
    display: flex;
    align-items: center;
    gap: 2px;
  }
  .serp-display-url {
    font-size: 13px;
    color: var(--serp-url);
    font-family: arial, sans-serif;
  }
  .serp-headline {
    font-size: 20px;
    line-height: 1.3;
    color: #1a0dab;
    font-family: arial, sans-serif;
    cursor: pointer;
    margin-bottom: 4px;
  }
  .serp-headline:hover { text-decoration: underline; }
  .serp-description {
    font-size: 14px;
    line-height: 1.58;
    color: var(--serp-desc);
    font-family: arial, sans-serif;
  }
  .serp-hl-separator { color: #70757a; }

  /* SERP char counts */
  .serp-char-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px solid #f0f0f0;
  }
  .serp-char-pill {
    font-size: 10px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    padding: 2px 8px;
    border-radius: 10px;
    background: #f0f1f5;
    color: #64748b;
  }
  .serp-char-pill.over {
    background: #fef2f2;
    color: #dc2626;
    font-weight: 700;
  }
  .serp-char-pill.ok {
    background: #f0fdf4;
    color: #15803d;
  }
  .serp-alert {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 6px;
    padding: 6px 12px;
    margin-top: 10px;
    font-size: 11px;
    font-weight: 600;
    color: #dc2626;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .serp-alert-icon {
    font-size: 14px;
    line-height: 1;
  }
  .serp-container.has-errors {
    box-shadow: 0 0 0 2px #fecaca, 0 1px 4px rgba(0,0,0,.08);
  }

  /* Ad details panel */
  .ad-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    margin-bottom: 16px;
    overflow: hidden;
  }
  .ad-card-header {
    padding: 14px 18px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }
  .ad-card-header:hover { background: var(--surface2); }
  .ad-card-header h4 {
    font-size: 14px;
    font-weight: 600;
  }
  .ad-card-body {
    padding: 18px;
  }
  .ad-card-body.collapsed { display: none; }

  /* Headlines / Descriptions list */
  .hl-list {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-bottom: 14px;
  }
  .hl-tag {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 6px 12px;
    font-size: 12px;
    position: relative;
    cursor: text;
    min-width: 60px;
    transition: border-color .15s;
  }
  .hl-tag:focus-within { border-color: var(--accent); }
  .hl-tag .hl-num {
    font-size: 9px;
    color: var(--text-dim);
    position: absolute;
    top: -6px;
    left: 6px;
    background: var(--surface2);
    padding: 0 3px;
  }
  .hl-tag .char-count {
    font-size: 9px;
    color: var(--text-dim);
    position: absolute;
    top: -6px;
    right: 6px;
    background: var(--surface2);
    padding: 0 3px;
  }
  .hl-tag .char-count.over { color: #dc2626; font-weight: 700; }
  .hl-tag input {
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 12px;
    outline: none;
    width: 100%;
    font-family: inherit;
  }
  .desc-item {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 10px 14px;
    margin-bottom: 8px;
    position: relative;
    cursor: text;
    transition: border-color .15s;
  }
  .desc-item:focus-within { border-color: var(--accent); }
  .desc-item .hl-num {
    font-size: 9px;
    color: var(--text-dim);
    position: absolute;
    top: -6px;
    left: 8px;
    background: var(--surface2);
    padding: 0 3px;
  }
  .desc-item .char-count {
    font-size: 9px;
    color: var(--text-dim);
    position: absolute;
    top: -6px;
    right: 8px;
    background: var(--surface2);
    padding: 0 3px;
  }
  .desc-item .char-count.over { color: #dc2626; font-weight: 700; }
  .desc-item textarea {
    background: transparent;
    border: none;
    color: var(--text);
    font-size: 12px;
    outline: none;
    width: 100%;
    resize: none;
    font-family: inherit;
    line-height: 1.4;
  }
  .sub-label {
    font-size: 11px;
    color: var(--text-dim);
    margin-bottom: 8px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Keywords */
  .kw-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
  }
  .kw-table th {
    text-align: left;
    padding: 8px 12px;
    background: var(--surface2);
    color: var(--text-dim);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 1px solid var(--border);
  }
  .kw-table td {
    padding: 6px 12px;
    border-bottom: 1px solid var(--border);
  }
  .kw-table tr:hover { background: #f8f9fc; }
  .match-badge {
    font-size: 9px;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: 700;
  }
  .match-phrase { background: #dbeafe; color: #1e40af; }
  .match-neg { background: #fee2e2; color: #b91c1c; }
  .status-enabled { color: var(--green); }
  .status-paused { color: var(--yellow); }

  /* Toolbar */
  .toolbar {
    position: sticky;
    top: 0;
    z-index: 10;
    background: var(--bg);
    padding: 12px 0 16px;
    display: flex;
    gap: 10px;
    align-items: center;
    border-bottom: 1px solid var(--border);
    margin-bottom: 24px;
  }
  .btn {
    padding: 8px 18px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-size: 12px;
    cursor: pointer;
    font-weight: 600;
    transition: all .15s;
  }
  .btn:hover { background: var(--surface2); }
  .btn-primary { background: var(--accent); border-color: var(--accent); color: #fff; }
  .btn-primary:hover { background: #c93550; }
  .btn-success { background: #059669; border-color: #059669; color: #fff; }
  .save-status { font-size: 11px; color: var(--text-dim); margin-left: 8px; }
  .save-status.saved { color: #059669; }

  /* Location tags */
  .loc-tags { display: flex; gap: 6px; flex-wrap: wrap; }
  .loc-tag {
    background: #dbeafe;
    border: 1px solid #bfdbfe;
    border-radius: 4px;
    padding: 4px 10px;
    font-size: 12px;
    color: #1e40af;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .sidebar { width: 240px; min-width: 240px; }
    .main { padding: 16px; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
</style>
</head>
<body>

<div class="app">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h1>Fowler Homes Ads</h1>
      <p>25 campaigns &middot; 75 RSAs &middot; 345 keywords</p>
    </div>
    <div class="filter-bar">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="brand">Brand</button>
      <button class="filter-btn" data-filter="services">Services</button>
    </div>
    <div class="campaign-list" id="campaignList"></div>
  </div>

  <!-- Main -->
  <div class="main" id="mainContent">
    <div class="toolbar">
      <button class="btn btn-primary" onclick="saveToServer()" id="saveBtn">Save</button>
      <button class="btn" onclick="exportJSON()">Export JSON</button>
      <button class="btn btn-success" onclick="exportCSV()">Export CSV</button>
      <button class="btn" onclick="expandAll()">Expand All</button>
      <button class="btn" onclick="collapseAll()">Collapse All</button>
      <span class="save-status" id="saveStatus"></span>
      <span style="flex:1;"></span>
      <button class="btn" onclick="logout()" style="font-size:11px;padding:6px 12px;color:var(--text-dim);">Logout</button>
    </div>
    <div id="campaignDetail">
      <div style="text-align:center;padding:80px;color:var(--text-dim);">
        <p style="font-size:18px;margin-bottom:8px;">Select a campaign from the sidebar</p>
        <p style="font-size:13px;">Click any campaign to view SERP previews and edit ad copy</p>
      </div>
    </div>
  </div>
</div>

<script>
let DATA = null;
let currentCampaignIdx = null;
let dirty = false;

// Load JSON
async function loadData() {
  const resp = await fetch('ads_data.json');
  DATA = await resp.json();
  renderSidebar();
}

function renderSidebar(filter = 'all') {
  const list = document.getElementById('campaignList');
  list.innerHTML = '';
  DATA.campaigns.forEach((c, idx) => {
    const isBrand = c.name.includes('- Brand');
    if (filter === 'brand' && !isBrand) return;
    if (filter === 'services' && isBrand) return;

    const totalKw = c.ad_groups.reduce((s, ag) => s + ag.keywords.length, 0);
    const totalAds = c.ad_groups.reduce((s, ag) => s + ag.ads.length, 0);

    const el = document.createElement('div');
    el.className = 'campaign-item' + (currentCampaignIdx === idx ? ' active' : '');
    el.innerHTML = `
      <div class="name">
        <span class="badge ${isBrand ? 'badge-brand' : 'badge-services'}">${isBrand ? 'Brand' : 'Svc'}</span>
        ${c.name.replace(' - Brand', '').replace(' - Services', '')}
      </div>
      <div class="meta">
        <span>$${c.budget}/day</span>
        <span>${totalAds} ads</span>
        <span>${totalKw} kws</span>
        <span>${c.locations.join(', ')}</span>
      </div>
    `;
    el.onclick = () => selectCampaign(idx);
    list.appendChild(el);
  });
}

function selectCampaign(idx) {
  currentCampaignIdx = idx;
  const filter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';
  renderSidebar(filter);
  renderCampaign(DATA.campaigns[idx]);
}

function renderCampaign(c) {
  const detail = document.getElementById('campaignDetail');
  const isBrand = c.name.includes('- Brand');
  const locName = c.name.replace(' - Brand', '').replace(' - Services', '');

  let html = `
    <div class="campaign-header">
      <h2>
        <span class="badge ${isBrand ? 'badge-brand' : 'badge-services'}" style="font-size:12px;">${isBrand ? 'Brand' : 'Services'}</span>
        ${c.name}
      </h2>
      <div class="campaign-meta">
        <div class="meta-card"><label>Budget</label><div class="value">$${c.budget}/day</div></div>
        <div class="meta-card"><label>Status</label><div class="value"><span class="badge badge-enabled">${c.status}</span></div></div>
        <div class="meta-card"><label>Locations</label><div class="loc-tags">${c.locations.map(l => `<span class="loc-tag">${l}</span>`).join('')}</div></div>
      </div>
      ${c.comment ? `<div class="comment-bar">${c.comment}</div>` : ''}
      ${c.usps && c.usps.length ? `
        <div class="usp-box">
          <div class="usp-box-title">Region Unique Selling Points</div>
          <ul class="usp-list">
            ${c.usps.map(u => `<li class="usp-tag${u.startsWith('Note:') ? ' usp-note' : ''}">${escapeHtml(u)}</li>`).join('')}
          </ul>
        </div>
      ` : ''}
    </div>
  `;

  // For each ad group
  c.ad_groups.forEach((ag, agIdx) => {
    // SERP Previews
    html += `<div class="section">
      <div class="section-title">SERP Previews <span class="count">${ag.ads.length} RSAs</span></div>`;

    ag.ads.forEach((ad, adIdx) => {
      const h1 = ad.headlines[0]?.text || '';
      const h2 = ad.headlines[1]?.text || '';
      const h3 = ad.headlines[2]?.text || '';
      const d1 = ad.descriptions[0]?.text || '';
      const d2 = ad.descriptions[1]?.text || '';
      const domain = ad.final_url.replace('https://', '').replace('http://', '').replace(/\/$/, '');

      // Check for over-limit fields
      const hlErrors = ad.headlines.filter(h => h.text.length > 30);
      const descErrors = ad.descriptions.filter(d => d.text.length > 90);
      const hasErrors = hlErrors.length > 0 || descErrors.length > 0;

      html += `
        <div class="serp-container${hasErrors ? ' has-errors' : ''}" id="serp-${agIdx}-${adIdx}">
          <div class="serp-label">RSA ${adIdx + 1} of ${ag.ads.length}</div>
          <div class="serp-url-line">
            <div class="serp-favicon">F</div>
            <div class="serp-url-wrap">
              <span class="serp-display-url">${domain}</span>
            </div>
          </div>
          <div class="serp-ad-label"><span class="sponsored">Sponsored</span></div>
          <div class="serp-headline" id="serp-hl-${agIdx}-${adIdx}">
            ${h1}<span class="serp-hl-separator"> | </span>${h2}<span class="serp-hl-separator"> | </span>${h3}
          </div>
          <div class="serp-description" id="serp-desc-${agIdx}-${adIdx}">${d1} ${d2}</div>
          <div class="serp-char-bar" id="serp-chars-${agIdx}-${adIdx}">
            ${ad.headlines.map((h, i) => {
              const len = h.text.length;
              const cls = len > 30 ? 'over' : len >= 25 ? 'ok' : '';
              return `<span class="serp-char-pill ${cls}">H${i+1}: ${len}/30</span>`;
            }).join('')}
            ${ad.descriptions.map((d, i) => {
              const len = d.text.length;
              const cls = len > 90 ? 'over' : len >= 75 ? 'ok' : '';
              return `<span class="serp-char-pill ${cls}">D${i+1}: ${len}/90</span>`;
            }).join('')}
          </div>
          <div id="serp-alert-${agIdx}-${adIdx}">${hasErrors ? `<div class="serp-alert"><span class="serp-alert-icon">&#9888;</span>${hlErrors.length ? hlErrors.length + ' headline' + (hlErrors.length > 1 ? 's' : '') + ' over 30 chars' : ''}${hlErrors.length && descErrors.length ? ' &middot; ' : ''}${descErrors.length ? descErrors.length + ' description' + (descErrors.length > 1 ? 's' : '') + ' over 90 chars' : ''} — Google Ads will reject these</div>` : ''}</div>
        </div>
      `;
    });
    html += `</div>`;

    // Ad copy editor
    html += `<div class="section">
      <div class="section-title">Ad Copy Editor <span class="count">${ag.ads.length} RSAs</span></div>`;

    ag.ads.forEach((ad, adIdx) => {
      html += `
        <div class="ad-card">
          <div class="ad-card-header" onclick="toggleCard(this)">
            <h4>RSA ${adIdx + 1} &mdash; ${ad.headlines[0]?.text || 'Untitled'}</h4>
            <span style="color:var(--text-dim);font-size:12px;">${ad.headlines.length}H / ${ad.descriptions.length}D</span>
          </div>
          <div class="ad-card-body">
            <div class="sub-label">Headlines (max 30 chars each)</div>
            <div class="hl-list">
      `;
      ad.headlines.forEach((h, hIdx) => {
        const len = h.text.length;
        const over = len > 30;
        html += `
          <div class="hl-tag">
            <span class="hl-num">H${hIdx + 1}</span>
            <span class="char-count ${over ? 'over' : ''}" id="hlc-${agIdx}-${adIdx}-${hIdx}">${len}/30</span>
            <input type="text" value="${escapeHtml(h.text)}" maxlength="30"
              oninput="updateHL(${agIdx},${adIdx},${hIdx},this)"
              data-ag="${agIdx}" data-ad="${adIdx}" data-hl="${hIdx}">
          </div>
        `;
      });
      html += `</div>
            <div class="sub-label" style="margin-top:16px;">Descriptions (max 90 chars each)</div>`;
      ad.descriptions.forEach((d, dIdx) => {
        const len = d.text.length;
        const over = len > 90;
        html += `
          <div class="desc-item">
            <span class="hl-num">D${dIdx + 1}</span>
            <span class="char-count ${over ? 'over' : ''}" id="dc-${agIdx}-${adIdx}-${dIdx}">${len}/90</span>
            <textarea rows="2" maxlength="90"
              oninput="updateDesc(${agIdx},${adIdx},${dIdx},this)"
              data-ag="${agIdx}" data-ad="${adIdx}" data-desc="${dIdx}">${escapeHtml(d.text)}</textarea>
          </div>
        `;
      });
      html += `
            <div class="sub-label" style="margin-top:16px;">Final URL</div>
            <div class="desc-item">
              <input type="text" value="${escapeHtml(ad.final_url)}" style="background:transparent;border:none;color:var(--blue);font-size:12px;outline:none;width:100%;"
                oninput="updateURL(${agIdx},${adIdx},this)">
            </div>
          </div>
        </div>
      `;
    });
    html += `</div>`;

    // Keywords
    html += `<div class="section">
      <div class="section-title">Keywords <span class="count">${ag.keywords.length}</span></div>
      <table class="kw-table">
        <thead><tr><th>Keyword</th><th>Match</th><th>Status</th></tr></thead>
        <tbody>`;
    ag.keywords.forEach(kw => {
      html += `<tr>
        <td>${escapeHtml(kw.keyword)}</td>
        <td><span class="match-badge match-phrase">${kw.match_type}</span></td>
        <td><span class="${kw.status === 'Enabled' ? 'status-enabled' : 'status-paused'}">${kw.status}</span></td>
      </tr>`;
    });
    if (ag.negative_keywords.length) {
      ag.negative_keywords.forEach(kw => {
        html += `<tr>
          <td>${escapeHtml(kw.keyword)}</td>
          <td><span class="match-badge match-neg">${kw.match_type}</span></td>
          <td><span class="status-enabled">${kw.status}</span></td>
        </tr>`;
      });
    }
    html += `</tbody></table></div>`;
  });

  detail.innerHTML = html;
}

// Edit handlers
function updateHL(agIdx, adIdx, hlIdx, input) {
  const c = DATA.campaigns[currentCampaignIdx];
  c.ad_groups[agIdx].ads[adIdx].headlines[hlIdx].text = input.value;
  const counter = document.getElementById(`hlc-${agIdx}-${adIdx}-${hlIdx}`);
  const len = input.value.length;
  counter.textContent = `${len}/30`;
  counter.className = 'char-count' + (len > 30 ? ' over' : '');
  refreshSERP(agIdx, adIdx);
  markDirty();
}

function updateDesc(agIdx, adIdx, dIdx, textarea) {
  const c = DATA.campaigns[currentCampaignIdx];
  c.ad_groups[agIdx].ads[adIdx].descriptions[dIdx].text = textarea.value;
  const counter = document.getElementById(`dc-${agIdx}-${adIdx}-${dIdx}`);
  const len = textarea.value.length;
  counter.textContent = `${len}/90`;
  counter.className = 'char-count' + (len > 90 ? ' over' : '');
  refreshSERP(agIdx, adIdx);
  markDirty();
}

function updateURL(agIdx, adIdx, input) {
  const c = DATA.campaigns[currentCampaignIdx];
  c.ad_groups[agIdx].ads[adIdx].final_url = input.value;
  markDirty();
}

function refreshSERP(agIdx, adIdx) {
  const c = DATA.campaigns[currentCampaignIdx];
  const ad = c.ad_groups[agIdx].ads[adIdx];
  const hlEl = document.getElementById(`serp-hl-${agIdx}-${adIdx}`);
  const descEl = document.getElementById(`serp-desc-${agIdx}-${adIdx}`);
  if (hlEl) {
    const h1 = ad.headlines[0]?.text || '';
    const h2 = ad.headlines[1]?.text || '';
    const h3 = ad.headlines[2]?.text || '';
    hlEl.innerHTML = `${escapeHtml(h1)}<span class="serp-hl-separator"> | </span>${escapeHtml(h2)}<span class="serp-hl-separator"> | </span>${escapeHtml(h3)}`;
  }
  if (descEl) {
    const d1 = ad.descriptions[0]?.text || '';
    const d2 = ad.descriptions[1]?.text || '';
    descEl.textContent = d1 + ' ' + d2;
  }
  // Update char count pills
  const charsEl = document.getElementById(`serp-chars-${agIdx}-${adIdx}`);
  if (charsEl) {
    let pills = '';
    ad.headlines.forEach((h, i) => {
      const len = h.text.length;
      const cls = len > 30 ? 'over' : len >= 25 ? 'ok' : '';
      pills += `<span class="serp-char-pill ${cls}">H${i+1}: ${len}/30</span>`;
    });
    ad.descriptions.forEach((d, i) => {
      const len = d.text.length;
      const cls = len > 90 ? 'over' : len >= 75 ? 'ok' : '';
      pills += `<span class="serp-char-pill ${cls}">D${i+1}: ${len}/90</span>`;
    });
    charsEl.innerHTML = pills;
  }
  // Update alert
  const alertEl = document.getElementById(`serp-alert-${agIdx}-${adIdx}`);
  const container = document.getElementById(`serp-${agIdx}-${adIdx}`);
  if (alertEl) {
    const hlOver = ad.headlines.filter(h => h.text.length > 30);
    const descOver = ad.descriptions.filter(d => d.text.length > 90);
    if (hlOver.length || descOver.length) {
      container.classList.add('has-errors');
      let msg = '';
      if (hlOver.length) msg += hlOver.length + ' headline' + (hlOver.length > 1 ? 's' : '') + ' over 30 chars';
      if (hlOver.length && descOver.length) msg += ' &middot; ';
      if (descOver.length) msg += descOver.length + ' description' + (descOver.length > 1 ? 's' : '') + ' over 90 chars';
      alertEl.innerHTML = `<div class="serp-alert"><span class="serp-alert-icon">&#9888;</span>${msg} — Google Ads will reject these</div>`;
    } else {
      container.classList.remove('has-errors');
      alertEl.innerHTML = '';
    }
  }
}

function markDirty() {
  dirty = true;
  document.getElementById('saveStatus').textContent = 'Unsaved changes';
  document.getElementById('saveStatus').className = 'save-status';
}

// Export
async function saveToServer() {
  const btn = document.getElementById('saveBtn');
  const status = document.getElementById('saveStatus');
  btn.textContent = 'Saving...';
  btn.disabled = true;
  try {
    const resp = await fetch('/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(DATA, null, 2),
    });
    const result = await resp.json();
    if (result.ok) {
      status.textContent = 'Saved';
      status.className = 'save-status saved';
      dirty = false;
    } else {
      status.textContent = 'Save failed: ' + (result.error || 'unknown');
      status.className = 'save-status';
    }
  } catch (e) {
    status.textContent = 'Save failed: ' + e.message;
    status.className = 'save-status';
  }
  btn.textContent = 'Save';
  btn.disabled = false;
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(DATA, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ads_data.json';
  a.click();
  URL.revokeObjectURL(url);
  document.getElementById('saveStatus').textContent = 'JSON exported';
  document.getElementById('saveStatus').className = 'save-status saved';
  dirty = false;
}

function exportCSV() {
  // Build a simple summary CSV for review
  let csv = 'Campaign\tAd Group\tRSA #\tHeadline 1\tHeadline 2\tHeadline 3\tHeadline 4\tHeadline 5\tHeadline 6\tHeadline 7\tHeadline 8\tHeadline 9\tHeadline 10\tDescription 1\tDescription 2\tDescription 3\tDescription 4\tFinal URL\n';
  DATA.campaigns.forEach(c => {
    c.ad_groups.forEach(ag => {
      ag.ads.forEach((ad, i) => {
        const hls = [];
        for (let h = 0; h < 10; h++) hls.push(ad.headlines[h]?.text || '');
        const ds = [];
        for (let d = 0; d < 4; d++) ds.push(ad.descriptions[d]?.text || '');
        csv += [c.name, ag.name, i + 1, ...hls, ...ds, ad.final_url].map(v => `"${(v+'').replace(/"/g,'""')}"`).join('\t') + '\n';
      });
    });
  });
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'ads_review.csv';
  a.click();
  URL.revokeObjectURL(url);
  document.getElementById('saveStatus').textContent = 'CSV exported';
  document.getElementById('saveStatus').className = 'save-status saved';
}

// Utils
function toggleCard(header) {
  const body = header.nextElementSibling;
  body.classList.toggle('collapsed');
}

function expandAll() {
  document.querySelectorAll('.ad-card-body').forEach(el => el.classList.remove('collapsed'));
}

function collapseAll() {
  document.querySelectorAll('.ad-card-body').forEach(el => el.classList.add('collapsed'));
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    renderSidebar(btn.dataset.filter);
  };
});

// Warn on close
window.addEventListener('beforeunload', e => {
  if (dirty) {
    e.preventDefault();
    e.returnValue = '';
  }
});

function logout() {
  fetch('/logout', { method: 'POST' }).then(() => {
    window.location.href = '/login';
  }).catch(() => {
    window.location.href = '/login';
  });
}

// Init
loadData();
</script>

</body>
</html>
